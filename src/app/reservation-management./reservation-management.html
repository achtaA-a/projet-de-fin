<div class="management-container">
  <!-- En-t√™te avec statistiques -->
  <div class="management-header">
    <div class="header-content">
      <div class="title-section">
        <div class="title-icon">
          <i class="icon">üìã</i>
        </div>
        <div class="title-text">
          <h1>Gestion des R√©servations</h1>
          <p class="subtitle">G√©rez et suivez toutes les r√©servations de vols</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" (click)="loadReservations()" [disabled]="loading">
          <i class="reload-icon" [class.spinning]="loading">üîÑ</i>
          {{ loading ? 'Chargement...' : 'Actualiser' }}
        </button>
        <button class="btn btn-primary" (click)="exportToCSV()" [disabled]="reservations.length === 0">
          <i>üìä</i>
          Exporter CSV
        </button>
      </div>
    </div>

    <!-- Cartes de statistiques -->
    <div *ngIf="stats" class="stats-grid">
      <div class="stat-card">
        <div class="stat-card-content">
          <div class="stat-icon total">
            <i>üìä</i>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ stats.totalReservations || 0 }}</span>
            <span class="stat-label">R√©servations totales</span>
          </div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-card-content">
          <div class="stat-icon revenue">
            <i>üí∞</i>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ (stats.chiffreAffaire || 0) | number:'1.0-0' }} FCFA</span>
            <span class="stat-label">Chiffre d'affaires</span>
          </div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-card-content">
          <div class="stat-icon average">
            <i>üìà</i>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ (stats.moyenneParReservation || 0) | number:'1.0-0' }} FCFA</span>
            <span class="stat-label">Moyenne par r√©servation</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de modification de r√©servation -->
  <div *ngIf="showEditModal" class="modal-overlay" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Modifier la r√©servation</h2>
        <button class="modal-close" (click)="closeEditModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <form #editForm="ngForm" (ngSubmit)="saveReservation()">
          <!-- Informations de vol -->
          <div class="form-section">
            <h3>Informations de vol</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="editDepart">D√©part</label>
                <select id="editDepart" [(ngModel)]="editReservationData.depart" name="depart" required>
                  <option value="NDJ">N'Djamena (NDJ)</option>
                  <option value="MQQ">Moundou (MQQ)</option>
                  <option value="AEH">Ab√©ch√© (AEH)</option>
                  <option value="FYT">Faya-Largeau (FYT)</option>
                  <option value="SRH">Sarh (SRH)</option>
                  <option value="PAR">Paris (CDG) - France</option>
                  <option value="LON">Londres (LHR) - Royaume-Uni</option>
                  <option value="IST">Istanbul (IST) - Turquie</option>
                  <option value="DXB">Duba√Ø (DXB) - √âmirats Arabes Unis</option>
                  <option value="NYC">New York (JFK) - √âtats-Unis</option>
                </select>
              </div>
              <div class="form-group">
                <label for="editDestination">Destination</label>
                <select id="editDestination" [(ngModel)]="editReservationData.destinationId" name="destinationId" required>
                  <option *ngFor="let dest of destinations" [value]="dest._id">
                    {{ dest.nom }} ({{ dest.code }})
                  </option>
                </select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="editNumeroVol">Num√©ro de vol</label>
                <input type="text" id="editNumeroVol" [(ngModel)]="editReservationData.vol.numeroVol" name="numeroVol" required>
              </div>
              <div class="form-group">
                <label for="editDateDepart">Date de d√©part</label>
                <input type="datetime-local" id="editDateDepart" [(ngModel)]="editReservationData.vol.dateDepart" name="dateDepart" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="editDateRetour">Date de retour</label>
                <input type="datetime-local" id="editDateRetour" [(ngModel)]="editReservationData.vol.dateRetour" name="dateRetour">
              </div>
              <div class="form-group">
                <label for="editClasse">Classe</label>
                <select id="editClasse" [(ngModel)]="editReservationData.vol.classe" name="classe" required>
                  <option value="economie">√âconomie</option>
                  <option value="affaire">Affaire</option>
                  <option value="premiere">Premi√®re</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Passagers -->
          <div class="form-section">
            <h3>Passagers</h3>
            <div *ngFor="let passager of editReservationData.passagers; let i = index" class="passager-section">
              <h4>Passager {{ i + 1 }}</h4>
              <div class="form-row">
                <div class="form-group">
                  <label [for]="'editPrenom' + i">Pr√©nom</label>
                  <input [id]="'editPrenom' + i" [(ngModel)]="passager.prenom" [name]="'prenom' + i" required>
                </div>
                <div class="form-group">
                  <label [for]="'editNom' + i">Nom</label>
                  <input [id]="'editNom' + i" [(ngModel)]="passager.nom" [name]="'nom' + i" required>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label [for]="'editDateNaissance' + i">Date de naissance</label>
                  <input [id]="'editDateNaissance' + i" type="date" [(ngModel)]="passager.dateNaissance" [name]="'dateNaissance' + i" required>
                </div>
                <div class="form-group">
                  <label [for]="'editPasseport' + i">Num√©ro de passeport</label>
                  <input [id]="'editPasseport' + i" [(ngModel)]="passager.numeroPasseport" [name]="'numeroPasseport' + i" required>
                </div>
              </div>
            </div>
          </div>

          <!-- Prix et statut -->
          <div class="form-section">
            <h3>Prix et statut</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="editPrixTotal">Prix total (FCFA)</label>
                <input type="number" id="editPrixTotal" [(ngModel)]="editReservationData.prixTotal" name="prixTotal" required min="0">
              </div>
              <div class="form-group">
                <label for="editStatut">Statut</label>
                <select id="editStatut" [(ngModel)]="editReservationData.statut" name="statut" required>
                  <option value="en_attente">En attente</option>
                  <option value="confirmee">Confirm√©e</option>
                  <option value="annulee">Annul√©e</option>
                </select>
              </div>
            </div>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Annuler</button>
        <button type="submit" class="btn btn-primary" (click)="saveReservation()" [disabled]="editForm.invalid || saving">
          {{ saving ? 'Sauvegarde...' : 'Sauvegarder' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Tableau des r√©servations -->
  <div class="table-section">
    <div class="table-header">
      <div class="table-title">
        <h2>Liste des R√©servations</h2>
        <span class="table-subtitle">Gestion compl√®te des r√©servations de vols</span>
      </div>
      <div class="table-controls">
        <div class="search-container">
          <div class="search-box">
            <i class="search-icon">üîç</i>
            <input type="text" placeholder="Rechercher une r√©servation, passager, destination..."
              [(ngModel)]="searchTerm" (input)="currentPage = 1" class="search-input">
            <button *ngIf="searchTerm" class="clear-search-btn" (click)="clearSearch()" title="Effacer la recherche">
              <i>‚úï</i>
            </button>
          </div>
        </div>


      </div>
    </div>

    <!-- √âtat de chargement -->
    <div *ngIf="loading" class="loading-state">
      <div class="loading-spinner"></div>
      <div class="loading-text">
        <h3>Chargement des r√©servations</h3>
        <p>Veuillez patienter pendant que nous r√©cup√©rons vos donn√©es...</p>
      </div>
    </div>

    <!-- Tableau des r√©sultats -->
    <div *ngIf="!loading && filteredReservations.length > 0" class="table-wrapper">
      <div class="table-responsive">
        <table class="reservations-table">
          <thead>
            <tr>
              <th class="reference-col">R√©f√©rence</th>
              <th class="departure-col">D√©part</th>
              <th class="destination-col">Destination</th>
              <th class="passengers-col">Passagers</th>
              <th class="names-col">Noms des Passagers</th>
              <th class="price-col">Prix Total</th>
              <th class="date-col">Date de cr√©ation</th>
              <th class="status-col">Statut</th>
              <th class="actions-col">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of paginatedReservations" class="reservation-row">
              <td class="reference-cell">
                <div class="reference-badge">
                  <strong>{{ r.referenceReservation }}</strong>
                </div>
              </td>
              <td class="departure-cell">
                <span class="airport-code">{{ r.depart }}</span>
              </td>
              <td class="destination-cell">
                <div class="destination-info">
                  <strong class="city-name">{{ r.destinationId?.nom || 'N/A' }}</strong>
                  <span class="airport-code">{{ r.destinationId?.code || r.vol?.destination }}</span>
                </div>
              </td>
              <td class="passengers-count-cell">
                <div class="passengers-badge">
                  <span class="passengers-count">{{ r.passagers?.length || 0 }}</span>
                  <i class="passengers-icon">üë•</i>
                </div>
              </td>
              <td class="passengers-names-cell">
                <div class="passengers-list">
                  <div *ngFor="let passager of r.passagers?.slice(0, 2)" class="passenger-item">
                    <span class="passenger-name">{{ passager.prenom }} {{ passager.nom }}</span>
                  </div>
                  <div *ngIf="r.passagers?.length > 2" class="more-passengers">
                    <span class="more-count">+{{ r.passagers.length - 2 }} autre(s)</span>
                  </div>
                  <div *ngIf="!r.passagers || r.passagers.length === 0" class="no-passengers">
                    <span class="no-data">Aucun passager</span>
                  </div>
                </div>
              </td>
              <td class="price-cell">
                <div class="price-amount">
                  <strong>{{ r.prixTotal | number:'1.0-0' }} FCFA</strong>
                </div>
              </td>
              <td class="date-cell">
                <div class="date-info">
                  <span class="date">{{ r.createdAt | date:'dd/MM/yyyy' }}</span>
                  <span class="time">{{ r.createdAt | date:'HH:mm' }}</span>
                </div>
              </td>
              <!-- Dans le tableau, remplacer la cellule de statut par : -->
              <td class="status-cell">
                <div class="status-container">
                  <select [(ngModel)]="r.statut" (change)="updateReservationStatus(r._id, r.statut)"
                    class="status-select" [class]="getStatusClass(r.statut)" [disabled]="r.saving">
                    <!-- CORRECTION: Toujours afficher "En attente" comme option par d√©faut -->
                    <option value="en_attente">En attente</option>
                    <option value="confirmee">Confirm√©e</option>
                    <option value="annulee">Annul√©e</option>
                  </select>
                  <div class="status-saving" *ngIf="r.saving">
                    <div class="mini-spinner"></div>
                  </div>
                </div>
              </td>
              <td class="actions-cell">
                <div class="action-buttons">
                  <button class="btn-action btn-edit" (click)="editReservation(r._id)" title="Modifier">
                    <i class="action-icon">‚úèÔ∏è</i>
                    <span class="action-text">Modifier</span>
                  </button>
                  <button class="btn-action btn-delete" (click)="deleteReservation(r._id)" title="Supprimer">
                    <i class="action-icon">üóëÔ∏è</i>
                    <span class="action-text">Supprimer</span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- √âtat vide -->
    <div *ngIf="!loading && filteredReservations.length === 0 && searchTerm" class="empty-state">
      <div class="empty-icon">
        <i>üîç</i>
      </div>
      <div class="empty-content">
        <h3>Aucun r√©sultat trouv√©</h3>
        <p>Aucune r√©servation ne correspond √† votre recherche "{{ searchTerm }}"</p>
        <button class="btn btn-outline" (click)="clearSearch()">Effacer la recherche</button>
      </div>
    </div>

    <div *ngIf="!loading && reservations.length === 0 && !searchTerm" class="empty-state">
      <div class="empty-icon">
        <i>üì≠</i>
      </div>
      <div class="empty-content">
        <h3>Aucune r√©servation trouv√©e</h3>
        <p>Il n'y a actuellement aucune r√©servation dans le syst√®me.</p>
        <button class="btn btn-primary" (click)="loadReservations()">Actualiser</button>
      </div>
    </div>

    <!-- Contr√¥les de pagination client -->
    <div *ngIf="!loading && filteredReservations.length > 0" class="client-pagination-controls">
      <div class="pagination-info">
        Affichage de {{ getStartIndex() }} √† {{ getEndIndex() }} sur {{ filteredReservations.length }} r√©servations
      </div>

      <div class="pagination-buttons">
        <button class="btn-pagination" [disabled]="currentPage === 1" (click)="previousPage()">
          ‚Äπ Pr√©c√©dent
        </button>

        <div class="page-numbers">
          <!-- <button 
            *ngFor="let page of getPageNumbers()" 
            class="btn-page-number"
            [class.active]="page === currentPage"
            [disabled]="page === '...'"
            (click)="page !== '...' && goToPage(page)">
            {{ page }}
          </button> -->
          <ng-container *ngFor="let page of getPageNumbers()">
            <!-- Si c'est "...", on affiche un label -->
            <span *ngIf="page === '...'" class="ellipsis">‚Ä¶</span>

            <!-- Sinon c'est un nombre cliquable -->
            <button *ngIf="page !== '...'" class="btn-page-number" [class.active]="page === currentPage"
              (click)="goToPage(page)">
              {{ page }}
            </button>
          </ng-container>
        </div>

        <button class="btn-pagination" [disabled]="currentPage === totalPages" (click)="nextPage()">
          Suivant ‚Ä∫
        </button>
      </div>
    </div>

    <!-- CORRECTION: Contr√¥les de pagination API -->
    <div class="api-pagination-controls">
      <div class="items-per-page">
        <label>√âl√©ments par page:</label>
        <select [(ngModel)]="itemsPerPage" (change)="onItemsPerPageChange()">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>
      </div>

      <div class="api-pagination-info">
        Page {{ apiPage }} sur {{ apiTotalPages }} ({{ apiTotalResults }} total)
      </div>

      <div class="api-pagination-buttons">
        <button class="btn-pagination" [disabled]="apiPage === 1" (click)="previousApiPage()">
          ‚Äπ Pr√©c.
        </button>
        <button class="btn-pagination" [disabled]="apiPage === apiTotalPages" (click)="nextApiPage()">
          Suiv. ‚Ä∫
        </button>
      </div>
    </div>